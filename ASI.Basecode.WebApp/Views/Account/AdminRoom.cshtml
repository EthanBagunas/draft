@model IEnumerable<ASI.Basecode.Data.Models.Room>
@using static ASI.Basecode.Resources.Views.Screen
@section Styles {
    <link rel="stylesheet" href="~/css/headerfinal.css" />
    <link rel="stylesheet" href="~/css/texts.css" />
    <link rel="stylesheet" href="~/css/style.css" />
    <link rel="stylesheet" href="~/css/homepage.css" />
    <link rel="stylesheet" href="~/css/adminroom.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link rel="icon" type="image/svg+xml" href="~/img/logo-invert.svg">
}
<!--copy ang script-->
@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/js/modal.js"></script>
    <script src="~/js/room-operations.js"></script>
    <script>
        console.log('Loading room operations scripts...');

        function showBookings(roomId) {
            console.log('showBookings called with roomId:', roomId);
            
            $.ajax({
                url: `/Account/GetBookingsbyRoomid?roomid=${roomId}`,
                type: 'POST',
                success: function(bookings) {
                    console.log('Received bookings data:', bookings);
                    
                    if (Array.isArray(bookings)) {
                        populateBookingsTable(bookings);
                        openBookingsModal();
                    } else {
                        console.error('Invalid response format:', bookings);
                        alert('Failed to fetch bookings');
                    }
                },
                error: function(error) {
                    console.error('Error fetching bookings:', error);
                    alert('Failed to fetch bookings');
                }
            });
        }

        function populateBookingsTable(bookings) {
            console.log('Populating bookings table with:', bookings);
            
            const tbody = document.getElementById('bookingsTableBody');
            if (!tbody) {
                console.error('Bookings table body not found!');
                return;
            }
            
            tbody.innerHTML = '';

            if (bookings.length === 0) {
                console.log('No bookings found');
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">No bookings found</td>';
                tbody.appendChild(row);
                return;
            }

            bookings.forEach(booking => {
                if (booking.status === 'RESERVED' || booking.status === 'VACANT') {
                    console.log('Processing booking:', booking);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.customer?.custfname || '--'}</td>
                        <td>${booking.customer?.contact || '--'}</td>
                        <td>${booking.bookingDate ? new Date(booking.bookingDate).toLocaleDateString() : '--'}</td>
                        <td>${booking.timeIn ? new Date('1970-01-01T' + booking.timeIn).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--'}</td>
                        <td>${booking.timeOut ? new Date('1970-01-01T' + booking.timeOut).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--'}</td>
                        <td>${booking.status}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function openBookingsModal() {
            console.log('Opening bookings modal');
            const modal = document.getElementById('bookingsModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal opened successfully');
            } else {
                console.error('Bookings modal element not found!');
            }
        }

        function closeBookingsModal() {
            console.log('Closing bookings modal');
            const modal = document.getElementById('bookingsModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('Modal closed successfully');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bookingsModal');
            if (event.target === modal) {
                closeBookingsModal();
            }
        }

        console.log('Room operations scripts loaded successfully');
    </script>
}
@{
    ViewBag.LoginView = true;
    ViewData["Title"] = "Room Information";
}

<div class= "custom-main-container">
    <!--search -->
    <div class="custom-room-box">
        <input id="roomSearchInput" placeholder="Search room name..." onkeyup="filterRoomTable()">
        <button><i class="fa-solid fa-magnifying-glass"></i></button>
    </div>
    <div class = "custom-room-search-filter-container">
        <div class= "room-page-title">
            <span class="page-title">Room Information</span>
        </div>

        <!-- Add View All Bookings button -->
        <div class="view-all-bookings-container">
            <button class="view-all-bookings-btn" onclick="showAllBookings()">
                <span>View All Bookings</span>

            </button>
        </div>
    </div>  

    <!--table-->
  <div class="custom-room-table-container">
    <div class="room-table">
      <table>
            <thead class="th-text">
            <tr>
                <th class="th-text">Room Number</th>
                <th class="th-text">Room Name</th>
                <th class="th-text">Capacity</th>
                <th class="th-text">Tools</th>
          </tr>
          </thead>

        <!--start sa content sa table-->
        <tbody class="td-text">
            @foreach (var room in Model)
            {
                <tr>
                    <td>#@room.RoomNumber</td>
                    <td>@room.Roomname</td>
                    <td>@room.MaxCapacity</td>
                    <td>
                        <div class="grid-item-toolbar">
                            <button class="grid-toolbar-button" onclick="editRoom(@room.Id)">
                                <i class="fa-regular fa-pen-to-square"></i>
                            </button>
                            <button class="grid-toolbar-button" onclick="deleteRoom(@room.Id)">
                                <i class="fa-regular fa-trash-can" style="color: #b3261e;"></i>
                            </button>
                            <button class="grid-toolbar-button" onclick="showBookings(@room.Id)">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>    
    </div>
    </table>
      <div class="custom-bottom-container">
     <div class="results-info">
        Showing 1 out of 10 results
    </div>
    <div class="custom-pagination-container">
        <div class="custom-pagination-btn">
            <!-- Pagination will be populated by JavaScript -->
        </div>
    </div>
    <div class="custom-add-container">
        <button class="add-booking-btn custom-main-white-text-normal" id="addUserForm" onclick="openModal()">
            <span>Add New</span>
        </button>
    </div>
 </div>
<!--modal html, copy ni-->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
           <div class="logo-container1">
                <img src="~/img/logo2.svg" style="width: 80px; color: 65558F; " alt="logo">
            </div>
        <div class="modal-header1">
            <h2>Add Room</h2>
        </div>
        <form id="addRoomForm" onsubmit="addRoom(event)">
            <div class="form-section">
                <h3>Room Information</h3>
                <label for="roomName">Room Name </label>
                <input type="text" id="roomName" name="roomName" placeholder="Enter room name" required>

                <label for="capacity">Capacity</label>
                <input type="text" id="capacity" name="capacity" placeholder="Enter capacity" required>
            </div>

            <div class="modal-footer1">
                <button type="button" class="cancel-bttn" onclick="closeModal()">Cancel</button>
                <button type="submit" class="submit-bttn">Submit</button>
            </div>
        </form>
    </div>
</div>

<div id="bookingsModal" class="modal">
    <div class="modal-content" style="width: 80%;">
        <span class="close" onclick="closeBookingsModal()">&times;</span>
        <div class="modal-header1">
            <h2>Room Bookings</h2>
        </div>
        <div class="bookings-table-container">
            <table class="bookings-table">
                <thead class="th-text">
                    <tr>
                        <th>Guest Name</th>
                        <th>Contact Number</th>
                        <th>Booking Date</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="bookingsTableBody" class="td-text">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add the new modal for all bookings -->
<div id="allBookingsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAllBookingsModal()">&times;</span>
        <div class="modal-header1">
            <h2>All Room Bookings</h2>
        </div>
        <div class="bookings-table-container">
            <table class="bookings-table">
                <thead class="th-text">
                    <tr>
                        <th class="sortable-header" data-sort="roomNumber">Room #</th>
                        <th class="sortable-header" data-sort="roomName">Room Name</th>
                        <th class="sortable-header" data-sort="guestName">Guest Name</th>
                        <th>Contact Number</th>
                        <th class="sortable-header" data-sort="bookingDate">Booking Date</th>
                        <th class="sortable-header" data-sort="timeIn">Time In</th>
                        <th class="sortable-header" data-sort="timeOut">Time Out</th>
                        <th class="sortable-header" data-sort="status">Status</th>
                    </tr>
                </thead>
                <tbody id="allBookingsTableBody" class="td-text">
                </tbody>
            </table>
        </div>
    </div>
</div>
